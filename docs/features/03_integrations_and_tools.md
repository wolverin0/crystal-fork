# Integrated Tools & Features

**Status:** Planned / In Progress
**Date:** January 11, 2026

Crystal is evolving from a simple session manager into a comprehensive "Agent IDE". This document outlines the roadmap for integrating external best-in-class tools directly into the Crystal workflow.

## 1. Visual Git Management (Lazygit)

**Goal:** Replace the manual "Step 3: Review Diffs" CLI pain with a full TUI (Terminal User Interface).

*   **Integration Point:** A new "Git Review" panel in the Session View.
*   **Mechanism:**
    *   Crystal spawns a `lazygit` process inside the session's worktree.
    *   The terminal panel renders the TUI.
*   **Why:**
    *   Allows interactive staging/discarding of specific lines (hunks) generated by the agent.
    *   Visual conflict resolution for merges.
*   **Status:** **Live**. Integrated via `LazygitPanel` and `LazygitManager`.

## 2. Advanced Security (Gitleaks)

**Goal:** Prevent agents from accidentally committing secrets (API keys, credentials) to the codebase.

*   **Integration Point:** The "Worker Bee" (Crystal Mind) and Pre-Commit Hooks.
*   **Mechanism:**
    *   **Real-time:** Before the Worker Bee analyzes a diff, it pipes the content to `gitleaks detect --no-git --pipe`.
    *   **Pre-commit:** Crystal runs `gitleaks protect` on the worktree before allowing a "Squash & Merge".
*   **Action:**
    *   If leak detected -> Block action.
    *   Alert user via Notification.
    *   Log to `MEMORIES.md` with `[SECURITY CRITICAL]` tag.
*   **Status:** **Live**. Integrated into `SessionManager` background scanning.

## 3. Environment Isolation (Direnv)

**Goal:** Allow different sessions to run with different configurations (e.g., Test DB vs Dev DB) without polluting the global environment.

*   **Integration Point:** Session Initialization.
*   **Mechanism:**
    *   When creating a session, Crystal checks for `.envrc` or `.env.session` in the worktree root.
    *   It parses these variables and injects them into the `env` object of the `pty` (pseudo-terminal) spawned for Claude/Codex.
*   **Why:** Essential for safe testing. An agent can be given a "sandbox" database credential in its specific session environment.
*   **Status:** **Medium Priority**.

## 4. Auto-Test & Feedback (Watchexec)

**Goal:** Create an instant feedback loop where code is tested the millisecond it is saved, feeding results back to the agent without manual intervention.

*   **Integration Point:** Background Session Service.
*   **Mechanism:**
    *   Crystal spawns a `watchexec` process for each active session.
    *   **Command:** `watchexec -e ts,js,py -- [test_command]`.
    *   **Workflow:**
        1. Agent saves a file.
        2. `watchexec` triggers the test suite.
        3. If tests fail, Crystal captures the output and (optionally) auto-injects it into the agent's prompt: *"The changes you just saved caused a test failure: [Error log]. Please fix."*
*   **Why:** This removes the "Did it work?" turn from the conversation, speeding up development.
*   **Status:** **Live**. Integrated into session startup and error reporting.

## 5. Visual Testing (Claude in Chrome / Embedded Browser)

**Goal:** Allow agents to "see" and test the web application they are building directly within Crystal.

*   **Integration Point:** Embedded Browser Panel.
*   **Mechanism:**
    *   Uses Electron's native `WebContentsView` to render a live browser.
    *   Docked side-by-side with the code and logs.
*   **Status:** **Live**. Integrated via `BrowserPanel` and `BrowserViewManager`.

## 6. Local Voice Alerts (Piper TTS)

**Goal:** "Ambient Computing" alerts for critical events without requiring visual attention.

*   **Integration Point:** Background Services.
*   **Mechanism:**
    *   Use **Piper TTS** (fast, local, neural TTS).
    *   When "Crystal Mind" detects a critical pattern (e.g., "Build Failed" loop or "Secret Leaked"), it synthesizes a brief audio alert.
    *   Plays through system audio.
*   **Why:** Replaces expensive/slow cloud APIs like ElevenLabs. Zero latency, 100% privacy.
*   **Status:** **Medium Priority**.

## Summary Roadmap

1.  **Done:** Lazygit panel, Gitleaks security scan, Watchexec auto-testing, Embedded Browser View.
2.  **Next:** Direnv environment isolation and Piper TTS voice alerts.
